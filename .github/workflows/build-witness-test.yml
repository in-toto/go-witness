name: Build Witness CLI Test

on:
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened, ready_for_review ]
  push:
    branches: [ main, 'feat/*' ]

jobs:
  build-witness:
    name: Build Witness CLI with PR SHA
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "stable"

      - name: Build Witness CLI with current SHA
        run: |
          # Create temporary directory
          WITNESS_TMP_DIR=/tmp/witness-build-test
          rm -rf $WITNESS_TMP_DIR
          mkdir -p $WITNESS_TMP_DIR
          
          # Get current SHA
          CURRENT_SHA=$(git rev-parse HEAD)
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          GO_WITNESS_MODULE=github.com/in-toto/go-witness
          
          echo "Using go-witness SHA: $CURRENT_SHA"
          echo "Current branch: $CURRENT_BRANCH"
          
          # Clone witness repository
          git clone https://github.com/in-toto/witness.git $WITNESS_TMP_DIR
          
          # Update go-witness dependency to use our current SHA
          cd $WITNESS_TMP_DIR
          go get $GO_WITNESS_MODULE@$CURRENT_SHA
          go mod tidy
          
          # Build witness
          go build -o witness .
          
          echo "Witness successfully built with go-witness SHA: $CURRENT_SHA"
          echo "Binary located at: $WITNESS_TMP_DIR/witness"
          
          # Verify the binary works
          ./witness version